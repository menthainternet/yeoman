#!/usr/bin/env node
var fs = require('fs'),
  join = require('path').join,
  help = join(__dirname, 'help.txt'),
  spawn = require('child_process').spawn,
  rl = require('readline'),
  pkg = require('../package.json');

// grunt with the plugin registered
var grunt = require('grunt').npmTasks(join(__dirname, '../'));

// Get back a reference to the internal grunt cli object (Yes, it's hacky) We
// need this to be able to read grunt command line parsed options and tasks to
// run to hook our internal additional logic.
//
// Another (nicer) alternative is to redo the command line parsing with nopt,
// but it'll add yet another dependency for a very little thing
var cli =  require('grunt/lib/grunt/cli');

// command line options and remaining args
var opts = cli.options,
  cmds = cli.tasks,
  route = cmds.join(' ').trim('');

// custom help, on `h5bp help`
if(/^help/.test(route)) {
  if(/^help$/.test(route)) return fs.createReadStream(help).pipe(process.stdout);
  cli.tasks = cmds.join(':');
}

// add the plugin version on `--version`
if(opts.version) {
  console.log('h5bp  v%s', pkg.version);
}

// `h5bp init` -> `grunt init:h5bp`
if(/^init$/.test(route)) {
  cli.tasks = 'init:yeoman';
}

// a nest command?
if(/^install|uninstall|search|update/.test(route)) {
  cli.tasks = 'nest' + ':' + cmds.join(':');
}

// Record this action in Insight.
var metricsFolder = join(__dirname, '..', '..', 'metrics/');
var insightScript = [metricsFolder + 'insight.py', 'record'];

var insight = spawn('python', insightScript.concat(cmds));
//insight.stdout.pipe(process.stdout);

fs.stat(metricsFolder + '.yeomaninsight', function(err, stats) {
  // Error means file doesn't exist and this is the first run.
  // Go through stat opt-in flow.
  if (err) {
    var msg = "==========================================================================\n\
We're constantly looking for ways to make " + pkg.name + " better!\n\
May we anonymously report usage statistics to improve the tool over time?\n\
More info: XXX\n\
==========================================================================\n\
[Y/n]: ";

    var i = rl.createInterface(process.stdin, process.stdout, null);
    i.question(msg, function(answer) {
      if (!(answer == '' || answer.toUpperCase() == 'Y')) {
        var insight = spawn('python', insightScript.concat(['NO_STATS']));
      }
      i.close();
      process.stdin.destroy();
    });
  }
});

// if the route is empty
if(/^$/.test(route)) {
  // this is specific to an empty route code
  console.log(pkg.name + ' v%s', pkg.version);

  // we return early to prevent grunt from actually running
  // and instead just output help.txt
  return fs.createReadStream(help).pipe(process.stdout);
}

// the grunt cli
grunt.cli();
